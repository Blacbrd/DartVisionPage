<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>Download video</title>
        <style>
            :root {
                --bg: #f6f7fb;
                --card: #fff;
                --accent: #111;
                --muted: #666;
            }

            html,
            body {
                height: 100%;
                margin: 0;
                font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
                background: var(--bg);
            }

            .wrap {
                min-height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            }

            .card {
                max-width: 480px;
                width: 100%;
                background: var(--card);
                border-radius: 14px;
                box-shadow: 0 14px 40px rgba(2, 6, 23, 0.08);
                padding: 32px;
                text-align: center;
            }

            h1 {
                margin: 0 0 8px;
                font-size: 20px;
            }

            p {
                color: var(--muted);
                margin: 0 0 20px;
            }

            .btn {
                display: inline-block;
                padding: 12px 20px;
                border-radius: 10px;
                border: none;
                background: var(--accent);
                color: #fff;
                font-weight: 700;
                font-size: 16px;
                cursor: pointer;
                text-decoration: none;
            }

            small {
                display: block;
                margin-top: 12px;
                color: var(--muted);
                font-size: 13px;
            }

            .warning {
                color: #a00;
                margin-top: 12px;
                font-size: 13px;
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <div class="card" id="card">
                <h1>Download video</h1>
                <p id="desc">Tap the button below to download the file.</p>
                <a id="btn" class="btn" href="#" role="button" rel="noopener noreferrer">Download video</a>
                <small>
                    If tapping doesn't start the download, open this page in your browser
                    or long-press the button and choose "Open in new tab".
                </small>
                <div id="warn" class="warning" style="display:none"></div>
            </div>
        </div>

        <script>
            // Read ?url=... from query string (expected to be the temp.sh page URL)
            const params = new URLSearchParams(window.location.search);
            const url = params.get('url');

            const btn = document.getElementById('btn');
            const warn = document.getElementById('warn');
            const desc = document.getElementById('desc');

            function isLikelyUrl(u) {
                if (!u) return false;
                try {
                    const parsed = new URL(u);
                    return parsed.protocol === 'https:' || parsed.protocol === 'http:';
                } catch (e) {
                    return false;
                }
            }

            // Submit a form via POST into a new tab/window so temp.sh receives the POST like its own form button.
            function postToUrlInNewTab(postUrl) {
                // Create a form and submit it to a new tab. This is NOT an AJAX request.
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = postUrl;
                // Use _blank so current page stays where it is and the download happens in the new tab.
                form.target = '_blank';
                // temp.sh's page uses an empty POST form, so no inputs required.
                form.style.display = 'none';
                document.body.appendChild(form);

                // Submit; because this is in direct response to a user click, popup blockers usually allow it.
                try {
                    form.submit();
                } catch (e) {
                    // Some browsers might block programmatic submit->new-tab; fallback to opening new window and writing an auto-submit form in it.
                    try {
                        const w = window.open('', '_blank', 'noopener');
                        if (w) {
                            // Build a small HTML string that assigns a safe JS string for the action.
                            // JSON.stringify ensures the URL is safely embedded as a JS string literal.
                            var actionLit = JSON.stringify(postUrl);
                            var newWindowHtml =
                                '<!doctype html><html><head><meta charset="utf-8"/></head><body>' +
                                '<form id="f" method="POST"></form>' +
                                '<script>' +
                                'var a = ' + actionLit + ';' +
                                'document.getElementById("f").action = a;' +
                                'document.getElementById("f").submit();' +
                                '<\/script>' +
                                '</body></html>';
                            w.document.write(newWindowHtml);
                            w.document.close();
                        } else {
                            // ultimate fallback: navigate current page
                            window.location.href = postUrl;
                        }
                    } catch (inner) {
                        // fallback to navigating current page (will show temp.sh page)
                        window.location.href = postUrl;
                    }
                } finally {
                    // cleanup
                    setTimeout(() => form.remove(), 1000);
                }
            }

            if (!isLikelyUrl(url)) {
                // No valid URL provided -> show helpful instruction
                btn.style.display = 'none';
                warn.style.display = 'block';
                warn.textContent =
                    'Download link missing or invalid. Ask the sender to regenerate the QR code.';
                desc.textContent = 'No download link found.';
            } else {
                // Attach click handler to post to the temp.sh page's form endpoint
                btn.addEventListener('click', function (ev) {
                    ev.preventDefault();
                    // Safety: only allow http/https
                    if (!isLikelyUrl(url)) {
                        warn.style.display = 'block';
                        warn.textContent = 'Invalid download URL.';
                        return;
                    }
                    postToUrlInNewTab(url);
                });
            }
        </script>
    </body>
</html>
